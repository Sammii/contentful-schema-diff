
import * as fs from 'fs-extra'
import * as path from 'path'
import { IContentType } from './model'

import { asyncWriter, indexById } from './utils';
import { writeCreate } from './create';
import { writeModify } from './modify';
import { writeDelete } from './delete';

export interface IArgs {
  from: string,
  to: string,
  oneFile: boolean,
  outDir: string
}

export default async function Run(args: IArgs) {

  const [from, to] = (await Promise.all([
    fs.readFile(args.from),
    fs.readFile(args.to)
  ])).map(b => JSON.parse(b.toString()))

  const fromTypes = indexById(from.contentTypes)
  const toTypes = indexById(to.contentTypes)

  const HEADER = `import Migration from 'contentful-migration-cli'

// Generated by contentful-schema-diff
// from ${args.from}
// to   ${args.to}
export = function (migration: Migration) {
`

  const FOOTER =`
}
`

  const fileName = `${new Date().toISOString().replace(/[^\d]/g, '').substring(0, 14)}_generated_from_diff.ts`
  const outputStream = fs.createWriteStream(path.join(args.outDir, fileName))
  const write = asyncWriter(outputStream)
  const runner = writeSingleFile

  await write(HEADER)

  const promises = Object.keys(toTypes).map(runner(write, async (id, chunkWriter) => {
    if (fromTypes[id]) {
      await writeModify(fromTypes[id], toTypes[id], chunkWriter)
    } else {
      await writeCreate(toTypes[id], chunkWriter)
    }
  }))
  promises.push(...Object.keys(fromTypes).map(runner(write, async (id, chunkWriter) => {
    if (toTypes[id]) {
      // handled above in 'writeModify'
      return
    }
    
    writeDelete(id, chunkWriter)
  })))

  await Promise.all(promises)

  await write(FOOTER)

  outputStream.close();
}

type AsyncWrite = (chunk: string) => Promise<any> 

function writeSingleFile(fileWriter: AsyncWrite, run: (id: string, write: AsyncWrite) => Promise<void>): (id: string) => Promise<void> {
  return async (id: string) => {
    let chunks: string[] = []

    await run(id, (chunk: string) => Promise.resolve(chunks.push(chunk)))

    if (chunks.length > 0) {
      await fileWriter(chunks.join(''))
    }
  }
}